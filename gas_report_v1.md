# NFTMarket Gas 消耗报告 v1

> 生成时间：2025-10-15
> 测试环境：Foundry + Solidity 0.8.0

---

## 📊 核心数据总结

### myNFTMarket 合约

| 指标 | Gas 消耗 | 说明 |
|------|----------|------|
| **部署成本** | 2,519,358 gas | 合约部署到链上的成本 |
| **listNFT** | 187,775 gas | 上架 NFT 的平均消耗 |
| **buyNFT** | 96,201 gas | 购买 NFT 的平均消耗 |
| **getListedNft** | 12,590 gas | 查询上架信息 |

### 关键发现

- ✅ **最贵操作**：listNFT (187k gas) - 包含 NFT 转账和存储写入
- ✅ **常用操作**：buyNFT (96k gas) - 包含代币和 NFT 转账
- ✅ **优化潜力**：部署成本较高 (2.5M gas)，可通过代码优化降低

### 测试覆盖

- **测试用例**：21 个
- **通过率**：100% (21/21)
- **不变量测试**：256 次运行，128,000 次调用
- **模糊测试**：包含随机价格和地址测试

---

## 📈 详细报告

以下是完整的测试执行和 Gas 统计数据：

---


No files changed, compilation skipped

Ran 21 tests for test/NFTMarket.t.sol:NFTMarketTest
[PASS] invariant_NoTokenBalance() (runs: 256, calls: 128000, reverts: 102337)

╭-------------+-------------------+-------+---------+----------╮
| Contract    | Selector          | Calls | Reverts | Discards |
+==============================================================+
| MyErc20     | approve           | 8539  | 10      | 0        |
|-------------+-------------------+-------+---------+----------|
| MyErc20     | mint              | 8416  | 8410    | 0        |
|-------------+-------------------+-------+---------+----------|
| MyErc20     | renounceOwnership | 8508  | 8497    | 0        |
|-------------+-------------------+-------+---------+----------|
| MyErc20     | transfer          | 8493  | 8371    | 0        |
|-------------+-------------------+-------+---------+----------|
| MyErc20     | transferFrom      | 8586  | 8475    | 0        |
|-------------+-------------------+-------+---------+----------|
| MyErc20     | transferOwnership | 8487  | 8484    | 0        |
|-------------+-------------------+-------+---------+----------|
| BaseERC721  | approve           | 8503  | 8503    | 0        |
|-------------+-------------------+-------+---------+----------|
| BaseERC721  | mint              | 8610  | 194     | 0        |
|-------------+-------------------+-------+---------+----------|
| BaseERC721  | safeTransferFrom  | 17053 | 17053   | 0        |
|-------------+-------------------+-------+---------+----------|
| BaseERC721  | setApprovalForAll | 8466  | 1       | 0        |
|-------------+-------------------+-------+---------+----------|
| BaseERC721  | transferFrom      | 8583  | 8583    | 0        |
|-------------+-------------------+-------+---------+----------|
| myNFTMarket | buyNFT            | 8532  | 8532    | 0        |
|-------------+-------------------+-------+---------+----------|
| myNFTMarket | listNFT           | 8545  | 8545    | 0        |
|-------------+-------------------+-------+---------+----------|
| myNFTMarket | tokenReceived     | 8679  | 8679    | 0        |
╰-------------+-------------------+-------+---------+----------╯

[PASS] testBuyNFT_Failed_Buy_Owner_NFT() (gas: 330750)
[PASS] testBuyNFT_Failed_Buy_Twice() (gas: 406599)
[PASS] testBuyNFT_Failed_InsufficientAllowance() (gas: 344806)
[PASS] testBuyNFT_Failed_InsufficientBalance() (gas: 395511)
[PASS] testBuyNFT_Failed_InvalidAddress() (gas: 278195)
[PASS] testBuyNFT_Failed_InvalidERC20Address() (gas: 280547)
[PASS] testBuyNFT_Failed_NotListed() (gas: 41620)
[PASS] testBuyNFT_Failed_PayTooLittle() (gas: 347272)
[PASS] testBuyNFT_Failed_PayTooMuch() (gas: 347203)
[PASS] testBuyNFT_Failed_ZeroPrice() (gas: 295716)
[PASS] testBuyNFT_Success() (gas: 456354)
[PASS] testEvents() (gas: 386457)
[PASS] testFuzz_ListNFT_Random_Price_Address(uint256,address,address,uint256) (runs: 256, μ: 615352, ~: 615780)
[PASS] testListNFTZeroPrice() (gas: 117565)
[PASS] testListNFT_Failed_AlreadyListed() (gas: 297208)
[PASS] testListNFT_Failed_InvalidAddress() (gas: 43336)
[PASS] testListNFT_Failed_InvalidERC20Address() (gas: 115180)
[PASS] testListNFT_Failed_NotOwner() (gas: 57613)
[PASS] testListNFT_NotApproved() (gas: 63893)
[PASS] testListNFT_Success() (gas: 284230)
Suite result: ok. 21 passed; 0 failed; 0 skipped; finished in 2.31s (2.43s CPU time)

╭-------------------------------------+-----------------+-------+--------+-------+---------╮
| src/ERC20Token.sol:MyErc20 Contract |                 |       |        |       |         |
+==========================================================================================+
| Deployment Cost                     | Deployment Size |       |        |       |         |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| 1146009                             | 6634            |       |        |       |         |
|-------------------------------------+-----------------+-------+--------+-------+---------|
|                                     |                 |       |        |       |         |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| Function Name                       | Min             | Avg   | Median | Max   | # Calls |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| allowance                           | 3201            | 3201  | 3201   | 3201  | 263     |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| approve                             | 5396            | 25740 | 25296  | 46976 | 8830    |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| balanceOf                           | 2851            | 2851  | 2851   | 2851  | 269     |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| mint                                | 32563           | 53992 | 54231  | 54243 | 561     |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| renounceOwnership                   | 7235            | 7235  | 7235   | 7235  | 11      |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| transfer                            | 7823            | 8745  | 7823   | 30523 | 123     |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| transferFrom                        | 10914           | 10914 | 10914  | 10914 | 111     |
|-------------------------------------+-----------------+-------+--------+-------+---------|
| transferOwnership                   | 7619            | 7619  | 7619   | 7619  | 3       |
╰-------------------------------------+-----------------+-------+--------+-------+---------╯

╭---------------------------------+-----------------+-------+--------+-------+---------╮
| src/nft.sol:BaseERC721 Contract |                 |       |        |       |         |
+======================================================================================+
| Deployment Cost                 | Deployment Size |       |        |       |         |
|---------------------------------+-----------------+-------+--------+-------+---------|
| 2168498                         | 11040           |       |        |       |         |
|---------------------------------+-----------------+-------+--------+-------+---------|
|                                 |                 |       |        |       |         |
|---------------------------------+-----------------+-------+--------+-------+---------|
| Function Name                   | Min             | Avg   | Median | Max   | # Calls |
|---------------------------------+-----------------+-------+--------+-------+---------|
| approve                         | 49495           | 49675 | 49663  | 49879 | 271     |
|---------------------------------+-----------------+-------+--------+-------+---------|
| getApproved                     | 3210            | 3210  | 3210   | 3210  | 272     |
|---------------------------------+-----------------+-------+--------+-------+---------|
| mint                            | 30476           | 48222 | 47576  | 69520 | 8733    |
|---------------------------------+-----------------+-------+--------+-------+---------|
| ownerOf                         | 1120            | 2299  | 3120   | 3120  | 1336    |
|---------------------------------+-----------------+-------+--------+-------+---------|
| setApprovalForAll               | 5097            | 14999 | 5097   | 24997 | 8505    |
╰---------------------------------+-----------------+-------+--------+-------+---------╯

╭----------------------------------------+-----------------+--------+--------+--------+---------╮
| src/nftmarket.sol:myNFTMarket Contract |                 |        |        |        |         |
+===============================================================================================+
| Deployment Cost                        | Deployment Size |        |        |        |         |
|----------------------------------------+-----------------+--------+--------+--------+---------|
| 2519358                                | 11499           |        |        |        |         |
|----------------------------------------+-----------------+--------+--------+--------+---------|
|                                        |                 |        |        |        |         |
|----------------------------------------+-----------------+--------+--------+--------+---------|
| Function Name                          | Min             | Avg    | Median | Max    | # Calls |
|----------------------------------------+-----------------+--------+--------+--------+---------|
| buyNFT                                 | 23280           | 96201  | 98701  | 98884  | 269     |
|----------------------------------------+-----------------+--------+--------+--------+---------|
| getListedNft                           | 12590           | 12590  | 12590  | 12590  | 258     |
|----------------------------------------+-----------------+--------+--------+--------+---------|
| listNFT                                | 29703           | 187775 | 191352 | 191592 | 275     |
╰----------------------------------------+-----------------+--------+--------+--------+---------╯


Ran 1 test suite in 2.40s (2.31s CPU time): 21 tests passed, 0 failed, 0 skipped (21 total tests)
